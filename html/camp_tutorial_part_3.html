<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CAMP: Boot CAMP: Part 3 - Updating CAMP Parameters</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/mhchem.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CAMP<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Chemistry Across Multiple Phases</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Boot CAMP: Part 3 - Updating CAMP Parameters </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >So far, we've <a class="el" href="camp_tutorial_part_1.html">built a simple box model</a> and <a class="el" href="camp_tutorial_part_2.html">set up a simple chemical mechanism</a> to run in that box model. Now, we're going to make some final adjustments to make this a fully operational box model. In many cases, the host model needs to provide some information to CAMP that changes over the course of a model run. We've seen how to update environmental conditions like temperature and pressure, but other information requires some knowledge of the system being modeled. In the case of our simple mechanism, this is \(\ce{NO2}\) photolysis. CAMP photolysis reactions need to know the photolysis rate at a given moment in the model run. Other reactions that need some external help include <a class="el" href="structcamp__rxn__emission_1_1rxn__emission__t.html">emissions</a>, <a class="el" href="structcamp__rxn__first__order__loss_1_1rxn__first__order__loss__t.html">first order loss</a>, and <a class="el" href="structcamp__rxn__wet__deposition_1_1rxn__wet__deposition__t.html">wet deposition</a>.</p>
<p >Let's update our box model to set the \(\ce{NO2}\) photolysis rate. Before the call to solver_initialize(), we'll add the following code:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__mechanism__data.html">camp_mechanism_data</a></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__rxn__data.html">camp_rxn_data</a></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__rxn__photolysis.html">camp_rxn_photolysis</a></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__rxn__factory.html">camp_rxn_factory</a></div>
<div class="line"> </div>
<div class="ttc" id="anamespacecamp__mechanism__data_html"><div class="ttname"><a href="namespacecamp__mechanism__data.html">camp_mechanism_data</a></div><div class="ttdoc">The mechanism_data_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="mechanism__data_8_f90_source.html#l00028">mechanism_data.F90:28</a></div></div>
<div class="ttc" id="anamespacecamp__rxn__data_html"><div class="ttname"><a href="namespacecamp__rxn__data.html">camp_rxn_data</a></div><div class="ttdoc">The rxn_data_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="rxn__data_8_f90_source.html#l00059">rxn_data.F90:59</a></div></div>
<div class="ttc" id="anamespacecamp__rxn__factory_html"><div class="ttname"><a href="namespacecamp__rxn__factory.html">camp_rxn_factory</a></div><div class="ttdoc">The abstract rxn_factory_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="rxn__factory_8_f90_source.html#l00170">rxn_factory.F90:170</a></div></div>
<div class="ttc" id="anamespacecamp__rxn__photolysis_html"><div class="ttname"><a href="namespacecamp__rxn__photolysis.html">camp_rxn_photolysis</a></div><div class="ttdoc">The rxn_photolysis_t type and associated functions.</div><div class="ttdef"><b>Definition:</b> <a href="rxn__photolysis_8_f90_source.html#l00061">rxn_photolysis.F90:61</a></div></div>
</div><!-- fragment --> <div class="fragment"><div class="line">  <span class="keywordtype">integer(kind=i_kind)</span> :: i_rxn</div>
<div class="line">  <span class="keywordtype">character(len=:)</span>, <span class="keywordtype">allocatable</span> :: photo_label</div>
<div class="line">  <span class="keywordtype">type</span>(mechanism_data_t), <span class="keywordtype">pointer</span> :: mechanism</div>
<div class="line">  <span class="keywordtype">type</span>(rxn_factory_t) :: rxn_factory</div>
<div class="line">  <span class="keywordtype">class</span>(rxn_data_t), <span class="keywordtype">pointer</span> :: photo_rxn</div>
<div class="line">  <span class="keywordtype">type</span>(rxn_update_data_photolysis_t) :: NO2_photolysis</div>
<div class="line"> </div>
</div><!-- fragment --> <div class="fragment"><div class="line">  <span class="keywordflow">if</span>( .not.camp_core%get_mechanism( <span class="stringliteral">&quot;my simple mechanism&quot;</span>, mechanism ) ) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keyword">write</span>(*,*) <span class="stringliteral">&quot;Missing mechanism!&quot;</span></div>
<div class="line">    stop 3</div>
<div class="line"><span class="keywordflow">  end if</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">do</span> i_rxn = 1, mechanism%size( )</div>
<div class="line">    photo_rxn =&gt; mechanism%get_rxn( i_rxn )</div>
<div class="line">    <span class="keywordflow">select type</span>( photo_rxn )</div>
<div class="line"><span class="keywordflow">      class is</span>( <a class="code hl_interface" href="structcamp__rxn__photolysis_1_1rxn__photolysis__t.html">rxn_photolysis_t</a> )</div>
<div class="line">        <span class="keywordflow">if</span>( photo_rxn%property_set%get_string( <span class="stringliteral">&quot;my photo label&quot;</span>, photo_label ) ) <span class="keywordflow">then</span></div>
<div class="line">          <span class="keywordflow">if</span>( photo_label .eq. <span class="stringliteral">&quot;NO2 photolysis&quot;</span> ) <span class="keywordflow">then</span></div>
<div class="line">            <span class="keyword">call </span>camp_core%initialize_update_object( photo_rxn, no2_photolysis )</div>
<div class="line"><span class="keywordflow">          end if</span></div>
<div class="line"><span class="keywordflow">        end if</span></div>
<div class="line"><span class="keywordflow">    end select</span></div>
<div class="line"><span class="keywordflow">  end do</span></div>
<div class="ttc" id="astructcamp__rxn__photolysis_1_1rxn__photolysis__t_html"><div class="ttname"><a href="structcamp__rxn__photolysis_1_1rxn__photolysis__t.html">camp_rxn_photolysis::rxn_photolysis_t</a></div><div class="ttdoc">Generic test reaction data type.</div><div class="ttdef"><b>Definition:</b> <a href="rxn__photolysis_8_f90_source.html#l00094">rxn_photolysis.F90:94</a></div></div>
</div><!-- fragment --><p >We first find the chemical mechanism, which we named <b>my simple mechanism</b> in the last part of the tutorial. Next, we cycle through the reactions in that mechanism looking for <a class="el" href="structcamp__rxn__photolysis_1_1rxn__photolysis__t.html">rxn_photolysis_t</a> reactions. Then, we check the properties of the photolysis reactions looking for a key-value pair name <b>my photo label</b> and make sure its value is <b>NO2 photolysis</b>, as we specified in the last section. The <a class="el" href="structcamp__rxn__data_1_1rxn__data__t.html#adeab6a80bd18af573d65b3789311a99b">property_set</a> of reactions gives you direct access to the input data for each reaction. This includes the information CAMP uses, like <b>reactants</b> and <b>A</b>, as well as those it doesn't use, like our <b>my photo label</b>. There are functions to get string, integers, real numbers, and subsets of properties from <a class="el" href="structcamp__rxn__data_1_1rxn__data__t.html#adeab6a80bd18af573d65b3789311a99b">property_set</a>. To see the available functions, see <a class="el" href="namespacecamp__property.html">camp_property</a>. The last step is to fix our <a class="el" href="structcamp__rxn__photolysis_1_1rxn__update__data__photolysis__t.html">rxn_update_data_photolysis_t</a> object to the \(\ce{NO2}\) photolysis reaction we located, then at the end just make sure we found the reaction we were looking for. This and similar objects for other reactions that accept external updates allow you to change reaction parameters during a model run.</p>
<p >Finally, we'll add the following code before we start to loop over time and solve the chemistry:</p>
<div class="fragment"><div class="line">  <span class="keyword">call </span>no2_photolysis%set_rate( 12.2d0 ) <span class="comment">! rate in s-1</span></div>
<div class="line">  <span class="keyword">call </span>camp_core%update_data( no2_photolysis )</div>
</div><!-- fragment --><p >Here, we simply set the reaction property of interest in our update data object, in this case the photolysis rate, and then pass this data to CAMP. This can be done before any call to <a class="el" href="namespacecamp__camp__core.html#a2c930e794dab3e8c87b47cbc35ea28a0">solve()</a>. This rate will remain the same until we change it again.</p>
<p >Now, our box model code and our input files are complete. To compile the code, try something like: </p><div class="fragment"><div class="line">gfortran -o run_box_model box_model.F90 -lcamp -I/usr/local/include/camp</div>
</div><!-- fragment --><p> Where the include path points to where the CAMP library <code></code>.mod files are installed. If you have trouble compiling or running because of missing libraries, make sure your <code>LD_LIBRARY_PATH</code> and <code>PATH</code> include the directories where the CAMP, json-fortran, SUNDIALS, and SuiteSparse libraries are installed.</p>
<p >Then, to run to mechanism: </p><div class="fragment"><div class="line">./run_box_model &gt; output.txt</div>
</div><!-- fragment --><p> If you have <a href="http://www.gnuplot.info/">gnuplot</a> installed, you can copy /doc/camp_tutorial/boot_camp/part_3_code/plot.conf to the directory with your results and check out them out: </p><div class="fragment"><div class="line">gnuplot plot.conf</div>
</div><!-- fragment --><p> Our results look like this:</p>
<div class="image">
<img src="BootCAMP_part_3_results.png" alt=""/>
</div>
<p >In the <a class="el" href="camp_tutorial_part_4.html">next installment</a> of Boot CAMP, we'll start passing messages!</p>
<p >The files described in this part of the tutorial and needed to run the box model and plot the results can be found in <code>/doc/camp_tutorial/boot_camp/part_3_code</code>.</p>
<hr  />
 <h3><a class="anchor" id="autotoc_md22"></a>
Docker Instructions</h3>
<p >Inside the container: </p><div class="fragment"><div class="line">dnf install -y gnuplot</div>
<div class="line">mkdir boot-camp</div>
<div class="line">cd boot-camp</div>
<div class="line">cp ../camp/doc/camp_tutorial/boot_camp/part_3_code/* .</div>
<div class="line">gfortran -o run_box_model box_model.F90 -lcamp -I/usr/local/include/camp</div>
<div class="line">./run_box_model &gt; output.txt</div>
<div class="line">gnuplot plot.conf</div>
<div class="line">exit</div>
</div><!-- fragment --><p> Back outside the container: </p><div class="fragment"><div class="line">docker cp camp:/boot-camp/results.png .</div>
<div class="line">docker container rm camp</div>
<div class="line">open results.png</div>
</div><!-- fragment --><hr  />
<p> <b> &lt; Previous: </b> <a class="el" href="camp_tutorial_part_2.html">Boot CAMP: Part 2 - Mechanism</a> <img src="icon_trail.png" alt="" class="inline"/> <a class="el" href="camp_tutorial.html">Index</a> <img src="icon_trail.png" alt="" class="inline"/> <b> Next: </b> <a class="el" href="camp_tutorial_part_4.html">Boot CAMP: Part 4 - Message Passing</a> <b> &gt; </b> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<hr class="footer"/><address class="footer"><small>
CAMP 1.0.0 documentation generated by <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.5</small></address>
</body>
</html>
