<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CAMP: Boot CAMP: Part 4 - Message Passing</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/mhchem.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CAMP<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Chemistry Across Multiple Phases</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Boot CAMP: Part 4 - Message Passing</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This part of <a class="el" href="camp_tutorial.html">Boot CAMP</a> shows how to use CAMP's message passing functions. If you're only interested in using CAMP on a single processor, you can skip this part and move on to <a class="el" href="camp_tutorial_part_5.html">Boot CAMP: Part 5 - Aerosol Representations</a>.</p>
<p>We'll wrap our MPI code with a compiler flag named <code>USE_MPI</code> to make sure our box model can be built with or without MPI. The order of operations is important for MPI runs and is summarized in the following table.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Process   </th><th class="markdownTableHeadNone">Operation    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">primary   </td><td class="markdownTableBodyNone"><code>camp_core =&gt; camp_core_t( input_files )</code>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">primary   </td><td class="markdownTableBodyNone"><code>call camp_core%initialize( )</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">primary   </td><td class="markdownTableBodyNone">access <code>camp_core_t</code> properties/set up <code>update_data_t</code> objects    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">primary   </td><td class="markdownTableBodyNone">pack all objects on a buffer    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">all   </td><td class="markdownTableBodyNone">pass the buffer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">secondary   </td><td class="markdownTableBodyNone"><code>camp_core =&gt; camp_core_t( )</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">secondary   </td><td class="markdownTableBodyNone">unpack the <code>camp_core_t</code> and other objects from the buffer    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">all   </td><td class="markdownTableBodyNone"><code>call camp_core%solver_initialize( )</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">all   </td><td class="markdownTableBodyNone">use <code>update_data_t</code> objects to update rates, etc.    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">all   </td><td class="markdownTableBodyNone"><code>call camp_core%solve( camp_state, time_step )</code>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">all   </td><td class="markdownTableBodyNone">deallocate all objects   </td></tr>
</table>
<p>We'll go through this step-by-step, update our box model and discuss why each process in done when and where it is.</p>
<p>Note that the CAMP MPI functions use <code>MPI_WORLD_COMM</code> by default, but they accept an optional <code>comm</code> argument if you would like to use a different communicator. See the specific function documentation for details.</p>
<p>First, let's add the modules we need for MPI. We'll use the standard mpi module and the CAMP mpi module, with some custom functions.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordtype">use </span>mpi</div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__mpi.html">camp_mpi</a></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="anamespacecamp__mpi_html"><div class="ttname"><a href="namespacecamp__mpi.html">camp_mpi</a></div><div class="ttdoc">Wrapper functions for MPI.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00013">mpi.F90:13</a></div></div>
</div><!-- fragment --><p>Now we'll declare a buffer, a position index, and a pack size</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordtype">integer(kind=i_kind)</span> :: pos, pack_size</div>
<div class="line">  <span class="keywordtype">character</span>, <span class="keywordtype">allocatable</span> :: buffer(:)</div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>Next, let's initialize MPI and wrap some of our existing code in a conditional statement that ensures we load the input data and initialize CAMP on the primary process only (we're including the existing call to the <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> constructor and <code>camp_core_t::initialize()</code> to show the placement of the start of our new conditional block):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a013fae7f812d8d9bd22dc73db714e115">camp_mpi_init</a>( )</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>( <a class="code hl_function" href="namespacecamp__mpi.html#a071b987e3ccab55010a23029249b73a4">camp_mpi_rank</a>( ) .eq. 0 ) <span class="keywordflow">then</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">    camp_core =&gt; camp_core_t( <span class="stringliteral">&quot;my_config_file.json&quot;</span> )</div>
<div class="line">    <span class="keyword">call </span>camp_core%initialize( )</div>
<div class="ttc" id="anamespacecamp__mpi_html_a013fae7f812d8d9bd22dc73db714e115"><div class="ttname"><a href="namespacecamp__mpi.html#a013fae7f812d8d9bd22dc73db714e115">camp_mpi::camp_mpi_init</a></div><div class="ttdeci">subroutine camp_mpi_init()</div><div class="ttdoc">Initialize MPI.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00057">mpi.F90:58</a></div></div>
<div class="ttc" id="anamespacecamp__mpi_html_a071b987e3ccab55010a23029249b73a4"><div class="ttname"><a href="namespacecamp__mpi.html#a071b987e3ccab55010a23029249b73a4">camp_mpi::camp_mpi_rank</a></div><div class="ttdeci">integer function camp_mpi_rank(comm)</div><div class="ttdoc">Returns the rank of the current process.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00127">mpi.F90:128</a></div></div>
</div><!-- fragment --><p>The <code>camp_core_t::initialize()</code> subroutine instructs the internal model elements to take their input data and condense it down into a small data block containing only the information they need to solve the chemical system during calls to <code>camp_core_t::solve()</code>. The <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> MPI functions pass only this condensed data to other processes. So, after the core is passed, you will not have access to the raw input data or model <a class="el" href="structcamp__property_1_1property__t.html">property_t</a> objects that we used to set up the <a class="el" href="structcamp__rxn__data_1_1rxn__update__data__t.html">rxn_update_data_t</a> objects in <a class="el" href="camp_tutorial_part_3.html">part 3</a>. Thus, all the setup of <a class="el" href="structcamp__rxn__data_1_1rxn__update__data__t.html">rxn_update_data_t</a> objects must be done on the primary process, before passing the core and update objects to the other processes.</p>
<p>So, let's end our first MPI conditional block after we setup the \(\ce{NO2}\) photolysis rxn_update_data_t object and before the call to <code>camp_core_t::solver_initialize()</code>. The first step is to get the size of the buffer to be used to pass the objects (the existing check that the \(\ce{NO2}\) photolysis update data object is attached is included to show the placement of the following code block):</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="comment">! Pack the core and the NO2 photolysis update data object</span></div>
<div class="line">    pack_size = camp_core%pack_size( )               + &amp;</div>
<div class="line">                no2_photolysis%pack_size( )</div>
<div class="line">    <span class="keyword">allocate</span>( buffer( pack_size ) )</div>
</div><!-- fragment --><p>After we allocate the buffer on the primary process, we'll pack it with the object data:</p>
<div class="fragment"><div class="line">    pos = 0</div>
<div class="line">    <span class="keyword">call </span>camp_core%bin_pack(      buffer, pos )</div>
<div class="line">    <span class="keyword">call </span>no2_photolysis%bin_pack( buffer, pos )</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">  end if</span> <span class="comment">! primary process</span></div>
</div><!-- fragment --><p>Next, we'll pass the species indexes we looked up. (Remember, we won't be able to do this on the secondary processes.)</p>
<div class="fragment"><div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi_bcast_integer</a>( idx_o3  )</div>
<div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi_bcast_integer</a>( idx_no  )</div>
<div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi_bcast_integer</a>( idx_no2 )</div>
<div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi_bcast_integer</a>( idx_o2  )</div>
<div class="ttc" id="anamespacecamp__mpi_html_a7b8bd92bfd70d41355c71943d41a528c"><div class="ttname"><a href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi::camp_mpi_bcast_integer</a></div><div class="ttdeci">subroutine camp_mpi_bcast_integer(val, comm)</div><div class="ttdoc">Broadcast the given value from process 0 to all other processes.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00316">mpi.F90:317</a></div></div>
</div><!-- fragment --><p>After we pack the objects and exit the primary process block, we'll pass the buffer to the other processes:</p>
<div class="fragment"><div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a7b8bd92bfd70d41355c71943d41a528c">camp_mpi_bcast_integer</a>( pack_size )</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span>( <a class="code hl_function" href="namespacecamp__mpi.html#a071b987e3ccab55010a23029249b73a4">camp_mpi_rank</a>( ) .gt. 0 ) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keyword">allocate</span>( buffer( pack_size ) )</div>
<div class="line"><span class="keywordflow">  end if</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a2b70614f7b7ae69f1ea2dc0256e5cc61">camp_mpi_bcast_packed</a>( buffer )</div>
<div class="ttc" id="anamespacecamp__mpi_html_a2b70614f7b7ae69f1ea2dc0256e5cc61"><div class="ttname"><a href="namespacecamp__mpi.html#a2b70614f7b7ae69f1ea2dc0256e5cc61">camp_mpi::camp_mpi_bcast_packed</a></div><div class="ttdeci">subroutine camp_mpi_bcast_packed(val, comm)</div><div class="ttdoc">Broadcast the given value from process 0 to all other processes.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00370">mpi.F90:371</a></div></div>
</div><!-- fragment --><p>Next, we'll unpack the objects on the secondary processes:</p>
<div class="fragment"><div class="line">  <span class="keywordflow">if</span>( <a class="code hl_function" href="namespacecamp__mpi.html#a071b987e3ccab55010a23029249b73a4">camp_mpi_rank</a>( ) .gt. 0 ) <span class="keywordflow">then</span></div>
<div class="line"> </div>
<div class="line">    camp_core =&gt; camp_core_t( )</div>
<div class="line">    pos = 0</div>
<div class="line">    <span class="keyword">call </span>camp_core%bin_unpack(      buffer, pos )</div>
<div class="line">    <span class="keyword">call </span>no2_photolysis%bin_unpack( buffer, pos )</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">  end if</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">deallocate</span>( buffer )</div>
<div class="line"><span class="preprocessor">#endif</span></div>
</div><!-- fragment --><p>Note that we call the <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> constructor without passing the input file list. This creates an empty core on the secondary processes that we can fill with the packed data from the buffer. After unpacking the objects and deallocating the buffer, our message passing is complete, and the rest of the code remains the same, beginning with the call to <code><a class="el" href="camp__solver_8c.html#a599ffdef916b139a1690bfd41aa386b6" title="Solver initialization.">solver_initialize()</a></code>.</p>
<p>This is not a very useful parallelization of our box model, as we're just solving the same system on every process, but it demonstrates how to initialize and pass the <code>camp_core_t</code> and <code>update_data_t</code> objects. The <code>camp_state_t::state_var(:)</code> array can be accessed directly and passed however your model passes double-precision floating-point arrays, or you can use the <code>camp_mpi_pack_size_real_array()</code>, <code>camp_mpi_pack_real_array()</code>, and <code>camp_mpi_unpack_real_array()</code> functions.</p>
<p>To finish up, let's add a conditional block around the output to print the results from the first secondary process, just to make sure our message passing is working, and finalize MPI.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span>( <a class="code hl_function" href="namespacecamp__mpi.html#a071b987e3ccab55010a23029249b73a4">camp_mpi_rank</a>( ) .eq. 1 ) <span class="keywordflow">then</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">    <span class="keyword">write</span>(*,fmt_hdr) <span class="stringliteral">&quot;time&quot;</span>, <span class="stringliteral">&quot;O3&quot;</span>, <span class="stringliteral">&quot;NO&quot;</span>, <span class="stringliteral">&quot;NO2&quot;</span>, <span class="stringliteral">&quot;O2&quot;</span></div>
<div class="line">    <span class="keywordflow">do</span> i_time = 1, 100</div>
<div class="line">      <span class="keyword">call </span>camp_core%solve( camp_state, 1.0d-15 ) <span class="comment">! time step in s</span></div>
<div class="line">      <span class="keyword">write</span>(*,fmt_dat) i_time*1.0e-15, &amp;</div>
<div class="line">                       camp_state%state_var( idx_o3  ), &amp;</div>
<div class="line">                       camp_state%state_var( idx_no  ), &amp;</div>
<div class="line">                       camp_state%state_var( idx_no2 ), &amp;</div>
<div class="line">                       camp_state%state_var( idx_o2  )</div>
<div class="line"><span class="keywordflow">    end do</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef CAMP_USE_MPI</span></div>
<div class="line"><span class="preprocessor"></span><span class="keywordflow">  end if</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">call </span><a class="code hl_function" href="namespacecamp__mpi.html#a6dab941cdb9b6b5681872411eeee2d1b">camp_mpi_finalize</a>( )</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="ttc" id="anamespacecamp__mpi_html_a6dab941cdb9b6b5681872411eeee2d1b"><div class="ttname"><a href="namespacecamp__mpi.html#a6dab941cdb9b6b5681872411eeee2d1b">camp_mpi::camp_mpi_finalize</a></div><div class="ttdeci">subroutine camp_mpi_finalize()</div><div class="ttdoc">Shut down MPI.</div><div class="ttdef"><b>Definition</b> <a href="mpi_8_f90_source.html#l00090">mpi.F90:91</a></div></div>
</div><!-- fragment --><p>To compile the model code with mpi, be sure to include the <code>USE_MPI</code> flag definition: </p><div class="fragment"><div class="line">mpif90 -o run_box_model box_model.F90 -DCAMP_USE_MPI -lcamp -I/usr/local/include/camp</div>
<div class="line">mpirun -v -np 2 run_box_model &gt; output.txt</div>
</div><!-- fragment --><p>In later installments of <a class="el" href="camp_tutorial.html">Boot CAMP</a> we'll include a section towards the end that describes any MPI-related code needed to run the updates described.</p>
<p>Now that our messages are passed, it's aerosol time. That's the topic of the <a class="el" href="camp_tutorial_part_5.html">next installment of Boot CAMP</a>!</p>
<hr  />
 <h3><a class="anchor" id="autotoc_md23"></a>
Docker Instructions</h3>
<p>To run a Docker container with MPI support, we'll need to build the image locally. So, we'll clone the CAMP repo, build the container with MPI and then run it: </p><div class="fragment"><div class="line">git clone https://github.com/open-atmos/camp.git</div>
<div class="line">cd camp</div>
<div class="line">docker build -f Dockerfile.mpi -t camp-test-mpi .</div>
<div class="line">docker run --name camp -it camp-test-mpi bash</div>
</div><!-- fragment --><p> Inside the container: </p><div class="fragment"><div class="line">sudo dnf install -y gnuplot</div>
<div class="line">mkdir boot-camp</div>
<div class="line">cd boot-camp</div>
<div class="line">cp ../camp/doc/camp_tutorial/boot_camp/part_4_code/* .</div>
<div class="line">mpif90 -o run_box_model box_model.F90 -DCAMP_USE_MPI -lcamp -I/usr/local/include/camp</div>
<div class="line">mpirun -v -np 2 run_box_model &gt; output.txt</div>
<div class="line">gnuplot plot.conf</div>
<div class="line">exit</div>
</div><!-- fragment --><p> Back outside the container: </p><div class="fragment"><div class="line">docker cp camp:/home/test_user/boot-camp/results.png .</div>
<div class="line">docker container rm camp</div>
<div class="line">open results.png</div>
</div><!-- fragment --><p> You should get the same results as described in <a class="el" href="camp_tutorial_part_3.html">Boot CAMP: Part 3 - Updating CAMP Parameters</a></p>
<hr  />
<p> <b> &lt; Previous: </b> <a class="el" href="camp_tutorial_part_3.html">Boot CAMP: Part 3 - Updating CAMP Parameters</a> <img src="icon_trail.png" alt="" class="inline"/> <a class="el" href="camp_tutorial.html">Index</a> <img src="icon_trail.png" alt="" class="inline"/> <b> Next: </b> <a class="el" href="camp_tutorial_part_5.html">Boot CAMP: Part 5 - Aerosol Representations</a> <b> &gt; </b> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<hr class="footer"/><address class="footer"><small>
CAMP 1.0.0 documentation generated by <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.8</small></address>
</body>
</html>
