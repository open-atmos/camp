<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CAMP: Boot CAMP: Part 1 - Box Model</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/mhchem.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_html_style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">CAMP<span id="projectnumber">&#160;1.0.0</span>
   </div>
   <div id="projectbrief">Chemistry Across Multiple Phases</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',false,false,'search.php','Search');
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Boot CAMP: Part 1 - Box <a class="el" href="struct_model.html">Model</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >Prior to beginning this tutorial, the CAMP library should be installed on your system. Installation instructions can be found <a class="el" href="index.html">here</a>. Alternatively, you can run CAMP in Docker following the instructions <a class="el" href="camp_tutorial.html">here</a>.</p>
<p >The purpose of this tutorial is to demonstrate how to integrate CAMP into a new host model, and use it to build and solve a unique chemical system. Over the the course of this tutorial, we will build a simple box model, add CAMP for the chemistry solving, and develop a simple chemical mechanism that makes use of all the CAMP functionality. Key features of CAMP will be demonstrated, including it's use with various aerosol representations (e.g., bins, modes, single particles), it's combined gas- and aerosol-phase solving, and it's run-time chemical mechanism configuration.</p>
<p >The box-model code in this tutorial is designed to make clear how to interact with CAMP, but it is not meant to represent a well-designed model. The code used in the tutorial can be found in <code>doc/camp_tutorial/boot_camp</code>.</p>
<h2><a class="anchor" id="autotoc_md21"></a>
CAMP box model</h2>
<p >First, let's build our simple box model. In a file named <code>box_model.F90</code>, add the following code to load the CAMP modules we'll need to get started:</p>
<div class="fragment"><div class="line"><span class="keyword">program</span> <a class="code hl_function" href="part__1__code_2box__model_8_f90.html#a3f8c0234515cc17b2f3e366868b8646b">box_model</a></div>
<div class="line"> </div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__camp__core.html">camp_camp_core</a></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__camp__state.html">camp_camp_state</a></div>
<div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__constants.html">camp_constants</a></div>
<div class="ttc" id="anamespacecamp__camp__core_html"><div class="ttname"><a href="namespacecamp__camp__core.html">camp_camp_core</a></div><div class="ttdoc">The camp_core_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="camp__core_8_f90_source.html#l00088">camp_core.F90:88</a></div></div>
<div class="ttc" id="anamespacecamp__camp__state_html"><div class="ttname"><a href="namespacecamp__camp__state.html">camp_camp_state</a></div><div class="ttdoc">The camp_state_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="camp__state_8_f90_source.html#l00009">camp_state.F90:9</a></div></div>
<div class="ttc" id="anamespacecamp__constants_html"><div class="ttname"><a href="namespacecamp__constants.html">camp_constants</a></div><div class="ttdoc">Physical constants.</div><div class="ttdef"><b>Definition:</b> <a href="constants_8_f90_source.html#l00009">constants.F90:9</a></div></div>
<div class="ttc" id="apart__1__code_2box__model_8_f90_html_a3f8c0234515cc17b2f3e366868b8646b"><div class="ttname"><a href="part__1__code_2box__model_8_f90.html#a3f8c0234515cc17b2f3e366868b8646b">box_model</a></div><div class="ttdeci">program box_model</div><div class="ttdef"><b>Definition:</b> <a href="part__1__code_2box__model_8_f90_source.html#l00002">part_1_code/box_model.F90:2</a></div></div>
</div><!-- fragment --><p >These modules provide two derived types that are needed in any CAMP implementation, <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> and <a class="el" href="structcamp__camp__state_1_1camp__state__t.html">camp_state_t</a>. CAMP employs an object-oriented design in which all of its functionality is exposed through instances of derived types. Most CAMP modules include one public derived type, with some exceptions we'll see later on.</p>
<p >Next, declare the needed variables and create and initialize a CAMP core:</p>
<div class="fragment"><div class="line">  <span class="keywordtype">type</span>(camp_core_t), <span class="keywordtype">pointer</span> :: camp_core</div>
<div class="line">  <span class="keywordtype">type</span>(camp_state_t), <span class="keywordtype">pointer</span> :: camp_state</div>
<div class="line"> </div>
</div><!-- fragment --> <div class="fragment"><div class="line">  camp_core =&gt; <a class="code hl_interface" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a>( <span class="stringliteral">&quot;my_config_file.json&quot;</span> )</div>
<div class="line">  <span class="keyword">call </span>camp_core%initialize( )</div>
<div class="ttc" id="astructcamp__camp__core_1_1camp__core__t_html"><div class="ttname"><a href="structcamp__camp__core_1_1camp__core__t.html">camp_camp_core::camp_core_t</a></div><div class="ttdoc">Part-MC model data.</div><div class="ttdef"><b>Definition:</b> <a href="camp__core_8_f90_source.html#l00122">camp_core.F90:122</a></div></div>
</div><!-- fragment --><p >The <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t()</a> constructor takes one argument: the path to a configuration file for the chemical mechanism you would like to run. (We'll create this a little later in the tutorial.) The constructor reads the input data and creates internal objects to describe the system (reactions, species, etc.). The initialize() function instructs these model elements to validate their input data and assemble the information they will need during solving.</p>
<p >In the first implementation of our box model, we will assume a fixed mechanism, so we will hard-code some species names. Later on we will use some <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> functions to retrieve the species present in the model at run time to avoid this.</p>
<div class="fragment"><div class="line">  <span class="keywordtype">use </span><a class="code hl_namespace" href="namespacecamp__chem__spec__data.html">camp_chem_spec_data</a></div>
<div class="line"> </div>
<div class="ttc" id="anamespacecamp__chem__spec__data_html"><div class="ttname"><a href="namespacecamp__chem__spec__data.html">camp_chem_spec_data</a></div><div class="ttdoc">The chem_spec_data_t structure and associated subroutines.</div><div class="ttdef"><b>Definition:</b> <a href="chem__spec__data_8_f90_source.html#l00032">chem_spec_data.F90:32</a></div></div>
</div><!-- fragment --> <div class="fragment"><div class="line">  <span class="keywordtype">integer(kind=i_kind)</span> :: idx_O3, idx_NO, idx_NO2, idx_O2</div>
<div class="line">  <span class="keywordtype">type</span>(chem_spec_data_t), <span class="keywordtype">pointer</span> :: chem_spec_data</div>
<div class="line"> </div>
</div><!-- fragment --> <div class="fragment"><div class="line">  <span class="keywordflow">if</span>( .not.camp_core%get_chem_spec_data( chem_spec_data ) ) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keyword">write</span>(*,*) <span class="stringliteral">&quot;Something&#39;s gone wrong!&quot;</span></div>
<div class="line">    stop 3</div>
<div class="line"><span class="keywordflow">  end if</span></div>
<div class="line"> </div>
<div class="line">  idx_o3  = chem_spec_data%gas_state_id( <span class="stringliteral">&quot;O3&quot;</span>  )</div>
<div class="line">  idx_no  = chem_spec_data%gas_state_id( <span class="stringliteral">&quot;NO&quot;</span>  )</div>
<div class="line">  idx_no2 = chem_spec_data%gas_state_id( <span class="stringliteral">&quot;NO2&quot;</span> )</div>
<div class="line">  idx_o2  = chem_spec_data%gas_state_id( <span class="stringliteral">&quot;O2&quot;</span>  )</div>
<div class="line">  <span class="keywordflow">if</span>( idx_o3.eq.0 .or. idx_no2.eq.0 .or.idx_o2.eq.0 ) <span class="keywordflow">then</span></div>
<div class="line">    <span class="keyword">write</span>(*,*) <span class="stringliteral">&quot;Missing species!&quot;</span></div>
<div class="line">    stop 3</div>
<div class="line"><span class="keywordflow">  end if</span></div>
</div><!-- fragment --><p >The <a class="el" href="structcamp__chem__spec__data_1_1chem__spec__data__t.html">chem_spec_data_t</a> object provides access to information about the chemical species present in the system. If there is a problem setting the <a class="el" href="structcamp__chem__spec__data_1_1chem__spec__data__t.html">chem_spec_data_t</a> pointer, for example if this function was called before initializing the <a class="el" href="structcamp__camp__core_1_1camp__core__t.html">camp_core_t</a> object, this function returns <code>false</code>, otherwise it returns <code>true</code>. The <a class="el" href="namespacecamp__chem__spec__data.html#ae877fd6fbaaac9755fb3c2ceb7c86824">gas_state_id()</a> function returns the index on the state array for a gas-phase species. We will use these indices later on to set the initial conditions and to retrieve the modeled species concentrations. The <a class="el" href="namespacecamp__chem__spec__data.html#ae877fd6fbaaac9755fb3c2ceb7c86824">gas_state_id()</a> function returns 0 if a species is not found, so it is important to check the values after calling this function.</p>
<p >Now, let's set up some conditions for our box model:</p>
<div class="fragment"><div class="line">  <span class="keyword">call </span>camp_core%solver_initialize( )</div>
<div class="line">  camp_state =&gt; camp_core%new_state( )</div>
<div class="line"> </div>
<div class="line">  <span class="keyword">call </span>camp_state%env_states(1)%set_temperature_K(  275.4_dp )</div>
<div class="line">  <span class="keyword">call </span>camp_state%env_states(1)%set_pressure_Pa( 101532.2_dp )</div>
<div class="line"> </div>
<div class="line">  camp_state%state_var( idx_o3   ) = 0.13  <span class="comment">! [O3] in ppm</span></div>
<div class="line">  camp_state%state_var( idx_no   ) = 0.02  <span class="comment">! [NO] in ppm</span></div>
<div class="line">  camp_state%state_var( idx_no2  ) = 0.053 <span class="comment">! [NO2] in ppm</span></div>
<div class="line">  camp_state%state_var( idx_o2   ) = 2.1e5 <span class="comment">! [O2] in ppm</span></div>
</div><!-- fragment --><p >The solver_initialize() function gets the external solver (<a href="https://computing.llnl.gov/projects/sundials/cvode">CVODE</a>) ready to solve the chemical system. The <code>camp_state</code> now can be used to describe the state of the chemical system. It contains species concentrations (for which we will provide initial conditions in the next part of the tutorial) and environmental parameters. The temperature and pressure can be updated at any time before or between calls to the CAMP <a class="el" href="namespacecamp__camp__core.html#a2c930e794dab3e8c87b47cbc35ea28a0">solve()</a> function, but <a class="el" href="namespacecamp__camp__state.html#a9a2bdbcfc5f7bb9c17265dec43939afa">update_env_state()</a> must be called after changing either of these properties. Gas-phase species on the state array are in ppm.</p>
<p >With that, all that's left is to solve the chemistry and output the results. We'll include a loop over time so we have something interesting to plot.</p>
<div class="fragment"><div class="line">  <span class="keywordtype">integer(kind=i_kind)</span> :: i_time</div>
<div class="line"> </div>
</div><!-- fragment --><div class="fragment"><div class="line">  <span class="keyword">write</span>(*,fmt_hdr) <span class="stringliteral">&quot;time&quot;</span>, <span class="stringliteral">&quot;O3&quot;</span>, <span class="stringliteral">&quot;NO&quot;</span>, <span class="stringliteral">&quot;NO2&quot;</span>, <span class="stringliteral">&quot;O2&quot;</span></div>
<div class="line">  <span class="keywordflow">do</span> i_time = 1, 100</div>
<div class="line">    <span class="keyword">call </span>camp_core%solve( camp_state, 1.0d-15 ) <span class="comment">! time step in s</span></div>
<div class="line">    <span class="keyword">write</span>(*,fmt_dat) i_time*1.0e-15, &amp;</div>
<div class="line">                     camp_state%state_var( idx_o3  ), &amp;</div>
<div class="line">                     camp_state%state_var( idx_no  ), &amp;</div>
<div class="line">                     camp_state%state_var( idx_no2 ), &amp;</div>
<div class="line">                     camp_state%state_var( idx_o2  )</div>
<div class="line"><span class="keywordflow">  end do</span></div>
<div class="line"> </div>
<div class="line">  <span class="keyword">deallocate</span>( camp_core )</div>
<div class="line">  <span class="keyword">deallocate</span>( camp_state )</div>
<div class="line"> </div>
<div class="line"><span class="keyword">end program </span><a class="code hl_function" href="part__1__code_2box__model_8_f90.html#a3f8c0234515cc17b2f3e366868b8646b">box_model</a></div>
</div><!-- fragment --><p >The <a class="el" href="namespacecamp__camp__core.html#a2c930e794dab3e8c87b47cbc35ea28a0">solve()</a> function advances the model state stored in <code>camp_state</code> by solving the chemistry over the time step specified in the second argument. We're keeping the time step small ( \(10^{-15}\) s) for now so we have something interesting to plot from these very fast reactions. Deallocating the <code>camp_core</code> and <code>camp_state</code> pointers releases all the memory associated with CAMP.</p>
<p >That's it for the initial box model code. Before we run the model, we'll need to describe the chemical system to solve. We'll do that in <a class="el" href="camp_tutorial_part_2.html">part 2 of Boot CAMP</a>!</p>
<p >The full box model code can be found in <code>\doc\camp_tutorial\part_1_code</code>.</p>
<hr  />
<p> <b> &lt; Previous: </b> <a class="el" href="camp_tutorial_part_0.html">Boot CAMP: Part 0 - Why CAMP?</a> <img src="icon_trail.png" alt="" class="inline"/> <a class="el" href="camp_tutorial.html">Index</a> <img src="icon_trail.png" alt="" class="inline"/> <b> Next: </b> <a class="el" href="camp_tutorial_part_2.html">Boot CAMP: Part 2 - Mechanism</a> <b> &gt; </b> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<hr class="footer"/><address class="footer"><small>
CAMP 1.0.0 documentation generated by <a href="http://www.doxygen.org/index.html">doxygen</a> 1.9.5</small></address>
</body>
</html>
